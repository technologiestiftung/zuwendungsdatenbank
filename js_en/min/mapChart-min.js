"use strict";var mapChart=function(t,e,a,n,l,o,r,s,p,c){var u={},i=c,d=p,v=s,f=t,y=a,g=n,h=[],b=o,x=r,m=l,k={},w=e,M={},L=f.append("svg").classed("mapChart",!0).attr("width",500).attr("height",400).attr("viewBox","0 0 500 400").attr("preserveAspectRatio","xMidYMid meet"),z=(L.append("defs").html('<linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:rgba(11,138,221,0.1);stop-opacity:1" /><stop offset="100%" style="stop-color:rgba(11,138,221,1);stop-opacity:1" /></linearGradient>'),L.append("g")),T=L.append("g"),C=L.append("g"),Y=C.append("path").style("fill","url(#grad1)"),A=C.append("text").text("0 €").attr("dy",22).style("font-size",10),O=C.append("text").text(currency(y.top(1)[0].value).replace("&nbsp;"," ")).attr("dy",22).style("font-size",10).attr("text-anchor","end"),P=L.append("g"),S=P.append("text").attr("text-anchor","middle"),X=(S.append("tspan").text("Sum (€)").attr("class","toggle sum").on("click",function(){X="sum",u.update()}),S.append("tspan").text(" / "),S.append("tspan").text("Count").attr("class","toggle count").on("click",function(){X="count",u.update()}),S.append("tspan").text(" / "),S.append("tspan").text("Ratio Sum/Count").attr("class","toggle ratio").on("click",function(){X="ratio",u.update()}),"sum"),Z=null,B=null,E=!0,F=d3.geoMercator().center([13.41,52.51]).scale(35e3).translate([250,200]),G=d3.scaleLinear().domain([0,Math.pow(y.top(1)[0].value,.25)]).range(["rgba(11,138,221,0.1)","rgba(11,138,221,1)"]),R=d3.scaleLinear().domain([0,Math.pow(g.top(1)[0].value,.25)]).range(["rgba(11,138,221,0.1)","rgba(11,138,221,1)"]),j=d3.scaleLinear().domain([0,Math.pow(d3.max(y.all(),function(t,e){return 0==g.all()[e].value||0==t.value?0:t.value/g.all()[e].value}),.25)]).range(["rgba(11,138,221,0.1)","rgba(11,138,221,1)"]),D=d3.geoPath().projection(F);return d&&(P.remove(),L.append("text").text(i).attr("transform","translate(75,65)").style("font-weight","bold").style("font-size","14px")),u.init=function(){w.features.forEach(function(t){M[t.properties.PLZ99]=t}),m.forEach(function(t){k[t.id]=t.label}),Z=z.selectAll("path").data(y.all()).enter().append("path").attr("d",function(t){return k[t.key]in M?D(M[k[t.key]]):""}).style("stroke-width",.5).style("stroke","rgba(255,255,255,1)"),B=T.selectAll("path").data(y.all()).enter().append("path").style("fill","transparent").style("stroke-width","2").classed("overlays",!0).attr("d",function(t){return k[t.key]in M?D(M[k[t.key]]):""}).on("click",function(t,e){b(x,t.key),u.updateToolTip(d3.event.pageX,d3.event.pageY,t,e)}).on("mousemove",function(t){v.move({x:d3.event.pageX,y:d3.event.pageY})}).on("mouseover",function(t,e){u.updateToolTip(d3.event.pageX,d3.event.pageY,t,e)}).on("mouseout",function(t){v.hide()}),u.resize()},u.switchDisplayMode=function(t){X=t,u.update()},u.updateToolTip=function(t,e,a,n){var l=!1;(0==h.length||h.indexOf(a.key)>-1)&&(l=!0),v.direction("horizontal"),v.show({title:9999999==k[a.key]?"Outside Berlin":"PLZ-".concat(k[a.key]),body:"Sum in €:<br /><i>".concat(currency(a.value))+(l?"&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;".concat((a.value/all.value()*100).toFixed(2),"%"):"")+"</i><br /><br />Number of grants:<br /><i>".concat(g.all()[n].value)+(l?"&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;".concat((g.all()[n].value/all_groups.value()*100).toFixed(2),"%"):"")+"</i>",x:t,y:e})},u.update=function(){switch(L.classed("count",!1).classed("sum",!1).classed("ratio",!1).classed(X,!0),Z.transition().duration(E?0:500).style("fill",function(t,e){switch(X){case"count":return R(Math.pow(g.all()[e].value,.25));case"sum":return G(Math.pow(t.value,.25));case"ratio":var a=0;return t.value>0&&g.all()[e].value>0&&(a=t.value/g.all()[e].value),j(Math.pow(a,.25))}}),B.classed("selected",function(t){return h.indexOf(t.key)>-1}),E=!1,X){case"count":A.text("0"),O.text(g.top(1)[0].value);break;case"sum":A.text("0 €"),O.text(currency(y.top(1)[0].value).replace("&nbsp;"," "));break;case"ratio":A.text("0 €"),O.text(currency(Math.floor(d3.max(y.all(),function(t,e){return 0==g.all()[e].value||0==t.value?0:t.value/g.all()[e].value}))).replace("&nbsp;"," "))}},u.resize=function(){P.attr("transform","translate(".concat(250,",10)")),C.attr("transform","translate(".concat(125,",").concat(350,")")),Y.attr("d","M0,4L".concat(250,",0L").concat(250,",10L0,6Z")),O.attr("dx",250),u.update()},u.data=function(t,e,a){y=t,g=e,h=a,G.domain([0,Math.pow(y.top(1)[0].value,.25)]),R.domain([0,Math.pow(g.top(1)[0].value,.25)]),j.domain([0,Math.pow(d3.max(y.all(),function(t,e){return 0==g.all()[e].value||0==t.value?0:t.value/g.all()[e].value}),.25)]),u.update()},u.hide=function(){f.style("display","none")},u.show=function(){f.style("display","block")},u};